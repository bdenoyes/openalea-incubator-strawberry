---
title: "Architecture_analysis"
author: "Marc LABADIE"
date: "5 juin 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE, dpi = 800,fig.pos = "h")
```

#Requierements

##Packages install 

```{r Package install ,eval=FALSE}
install.packages("plyr")
install.packages("ggplot2")
install.packages("gtable")
install.packages("grid")
install.packages("cowplot")
install.packages("reshape2")
install.packages("scales")
install.packages("knitr")
install.packages("tinytex")
install.packages("dplyr")
#install.packages("RCurl")
```

##Packages loading
```{r Package loading, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
library(plyr)
library(ggplot2)
library(gtable)
library(grid)
library(cowplot)
library(reshape2)
library(scales)
library(knitr)
library(tinytex)
library(dplyr)
#library(RCurl)
library(rmarkdown)
```

## Functions importing
```{r}
source(file = "c:/Users/mlabadie/Documents/GitHub/strawberry/Rscript/Functions.R")
```

#Import and transformation of dataset 

##Import dataset

INDEX_PARAMETER : TIME   # vertex_id

15 VARIABLES

VARIABLE 1 : INT  # nb_visible_leaves. No. elongated leaves (F)
VARIABLE 2 : INT  # nb_foliar_primordia No. primordia (f)
VARIABLE 3 : INT  # nb_total_leaves. Total no. leaves (F+f)
VARIABLE 4 : INT  # nb_open_flowers. No. open flowers
VARIABLE 5 : INT  # nb_aborted_flowers No. aborted flowers
VARIABLE 6 : INT  # nb_total_flowers Total no. flowers 
VARIABLE 7 : INT  # vegetative_bud. No. vegetative buds (axillary vegetative bud)
VARIABLE 8 : INT  # Initiated_bud. No. initiated bud (axillary initiated bud)
VARIABLE 9 : INT  # floral_bud. No. floral buds (axillary floral bud)
VARIABLE 10 : INT  # stolons No. stolons
VARIABLE 11 : INT  # type_of_crown. Type of crown (1: primary crown, 2: extention crowns, 3: branch crown)
VARIABLE 12 : INT  # Crown_status (1: Terminal Vegetative bud (bt, stage 17, 18, 19, None), 2:Terminal bud initiated (bt, stage A), 3: Terminal floral bud(ht), 4: Inflorescence(HT), -1: rotten or aborded)
VARIABLE 13 : INT  # genotype (1: Gariguette, 2: Ciflorette, 3: Clery, 4: Capriss, 5:Darselect, 6: Cir107)
VARIABLE 14 : INT  # date (1: mid December, 2: early Junuary, 3: mid February, 4: early March, 5: early April, 6: end May/early June)
VARIABLE 15 : INT  # plant. plant index

```{r Import dataset}
DataSet <- read.csv(
  "c:/Users/mlabadie/Documents/GitHub/strawberry/Rscript/Dataset.csv", 
  sep=";",na.strings = "-1")

colstart<-1
colend<-dim(DataSet)[2]-2

data<-DataSet[,c(colstart:colend)]
```

## Dataset Class Object
```{r Dataset Class Object}
str(object = data)
```

## Transformation of Class object
```{r Transformation of Class object}
data$genotype<- as.factor(data$genotype)
data$date<- as.factor(DataSet$date)
data$Crown_status<- as.factor(DataSet$Crown_status)
data$type_of_crown<- as.factor(DataSet$type_of_crown)
```

## Conversion of dataset
```{r Conversion of dataset}

# Convert numerical categorical ordered value in factor values with their properties 

data$genotype<- factor(x = data$genotype,
                       levels = levels(x = data$genotype),
                       labels = c("Gariguette","Ciflorette","Clery","Capriss","Darselect","Cir107")
                       )

data$date<- factor(x = data$date,
                   levels = levels(x = data$date),
                   labels = c("Mid-December","Early-Junuary","Mid-February","Early-March","Early-April","Early-June")
                   )

data$type_of_crown<- factor(x = DataSet$type_of_crown,
                            levels = levels(x = data$type_of_crown),
                            labels = c("Primary_Crown","Extention_Crown","Branch_Crown")
                            )
data$Crown_status<- factor(x = data$Crown_status,
                              levels = levels(x = data$Crown_status),
                              labels = c("Terminal_Vegetative_bud","Terminal_initiated_bud","Terminal_Floral_bud","Terminal_Inflorescence"))

```

```{r convert Index data}
#convert index sequence analysis in index for R analysis
dat<-data[2:colend]
for (i in 1:nrow(data)){ 
  if (data[i,'Index']=="0"){ 
    dat[i,"Index"]<- 0
  }else if (data[i,'Index']=="0-1"){
    dat[i,"Index"]<- 1
  }else if (data[i,'Index']=="0-1-2"){
    dat[i,"Index"]<- 2
  }else if (data[i,'Index']=="0-1-2-3"){
    dat[i,"Index"]<- 3
  }else if (data[i,'Index']=="0-1-2-3-4"){
    dat[i,"Index"]<- 4
  }else if (data[i,'Index']=="0-1-2-3-4-5"){
    dat[i,"Index"]<- 5
  }else if (data[i,'Index']=="1"){
    dat[i,"Index"]<- 1
  }else if (data[i,'Index']=="1-2"){
    dat[i,"Index"]<- 2
  }else if (data[i,'Index']=="1-2-3"){
    dat[i,"Index"]<- 3
  }else if (data[i,'Index']=="1-2-3-4"){
    dat[i,"Index"]<- 4
  }else if (data[i,'Index']=="1-2-3-4-5"){
    dat[i,"Index"]<- 5
  }else if (data[i,'Index']=="2"){
    dat[i,"Index"]<- 2
  }else if (data[i,'Index']=="2-3"){
    dat[i,"Index"]<- 3
  }else if (data[i,'Index']=="2-3-4"){
    dat[i,"Index"]<- 4
  }else if (data[i,'Index']=="3"){
    dat[i,"Index"]<- 3
  }else if (data[i,'Index']=="3-4"){
    dat[i,"Index"]<- 4
  }else if (data[i,'Index']=="4"){
    dat[i,"Index"]<- 4
  }
}

dat$Index<-as.factor(x = dat$Index)
```

# Exploratory analysis

## At module scale

** * Extraction of data at module scale **
```{r Extraction of data at module scale}
data_at_module_scale<-ddply(.data = dat,
                            .variables = c("genotype","Index"),
                            summarise,
                            MeanTotalLeave= round(x = mean(x = nb_total_leaves,
                                                           na.rm = T),
                                                  digits = 0),
                            SdTotalLeave= sd(x = nb_total_leaves,
                                  na.rm = T),
                            MeanTotalFlower= round(mean(x = nb_total_flowers,
                                                        na.rm = T),
                                                   digits = 0),
                            SdTotalFlower= sd(x = nb_total_flowers,
                                              na.rm = T),
                            MeanStolon= round(mean(x = stolons,
                                                   na.rm = T),
                                              digits = 0),
                            SdStolon= sd(x = stolons,
                                         na.rm = T),
                            N=length(nb_total_leaves))

kable(x = data_at_module_scale,caption = " Data at module scale")
```

### Number of Module for successive orders

```{r Number of Module for successive orders}
tab1<- fc_dist_module_by_order(data = dat)
kable(x = tab1,
      caption = "No. Module by varieties for successive orders "
      )
```

### Occurence of the higher order along time
```{r Occurence of the higher order along time}
tab2<- fc_dist_order_by_date(data = dat,
                             genotype = "Gariguette",
                             prob = "cumulative")
kable(x = tab2, 
      caption = "Module order frequency distribution for successive date",digits = 2)
```

```{r}
tab2<- data.frame(tab2)
ggplot(data = tab2,
       mapping = aes(x = Var1,
                     y = Freq,
                     group=Var2)
       )+
  geom_line(aes(color=Var2))+
  geom_point(aes(color=Var2))+
  xlab("Orders")+
  ylab("Probability")+
  guides(color= guide_legend(title = "Date"))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_discrete(expand = c(0,0))+
  theme_bw(base_size = 12,base_family = "Times")
 
```

```{r}
t<-table(dat[dat[,"genotype"]=="Gariguette",][,"Index"],
          dat[dat[,"genotype"]=="Gariguette",][,"date"])

t<-prop.table(t,2)
  
#t$freq<- margin.table(x = t,margin = 1)
```

```{r}
test<-data.frame(matrix(data = t,nrow = nrow(t),ncol = ncol(t)))
colnames(test)<- levels(x = dat$date)
row.names(test)<- c(levels(x = dat$Index))



d<-data.frame(matrix(nrow=nrow(test),ncol = ncol(test)))
colnames(d)<-colnames(test)
row.names(d)<-row.names(test)
d[1,]<-test[1,]
for (j in 1:ncol(d)){
  for (i in 2:nrow(d)){
    res<-d[i,j]<-d[i-1,j]+test[i,j]
    if(res==1){
      break
    }
  }
}

```

```{r}
colSums(test)
```

